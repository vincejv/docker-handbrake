From cb4fe0c2586e1190c3d4908e381361989b9d8a1d Mon Sep 17 00:00:00 2001
From: Vince JV <1276544+vincejv@users.noreply.github.com>
Date: Fri, 19 Apr 2024 13:46:34 +0800
Subject: [PATCH] Add subjective ssim and half-step increments

---
 libhb/common.c               | 2 +-
 libhb/encsvtav1.c            | 4 ++++
 libhb/handbrake/av1_common.h | 2 +-
 3 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/libhb/common.c b/libhb/common.c
index aad4493ce..d1e12302a 100644
--- a/libhb/common.c
+++ b/libhb/common.c
@@ -1483,7 +1483,7 @@ void hb_video_quality_get_limits(uint32_t codec, float *low, float *high,
         case HB_VCODEC_SVT_AV1:
         case HB_VCODEC_SVT_AV1_10BIT:
             *direction   = 1;
-            *granularity = 1.;
+            *granularity = 0.1;
             *low         = 0.;
             *high        = 63.;
             break;
diff --git a/libhb/encsvtav1.c b/libhb/encsvtav1.c
index ad346d056..70d904a17 100644
--- a/libhb/encsvtav1.c
+++ b/libhb/encsvtav1.c
@@ -197,6 +197,10 @@ int encsvtInit(hb_work_object_t *w, hb_job_t *job)
     {
         param->tune = 1;
     }
+    else if (job->encoder_tune != NULL && strstr("subjective ssim", job->encoder_tune) != NULL)
+    {
+        param->tune = 3;
+    }
     else
     {
         param->tune = 0;
diff --git a/libhb/handbrake/av1_common.h b/libhb/handbrake/av1_common.h
index 250c0cd6b..d33251db2 100644
--- a/libhb/handbrake/av1_common.h
+++ b/libhb/handbrake/av1_common.h
@@ -31,7 +31,7 @@ static const char * const av1_svt_preset_names[] =
 
 static const char * const av1_svt_tune_names[] =
 {
-    "psnr", "ssim", "fastdecode", NULL
+    "psnr", "ssim", "subjective ssim", "fastdecode", NULL
 };
 
 static const char * const av1_svt_profile_names[] =
-- 
2.34.1

